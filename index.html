<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Platform ANT+ Receiver</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        @media (min-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            .container {
                padding: 20px;
            }
            .header {
                margin-bottom: 30px;
            }
        }

        .platform-info {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
            backdrop-filter: blur(10px);
        }

        .platform-detected {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .connection-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .connection-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .connection-options {
                grid-template-columns: 1fr 1fr;
            }
        }

        .connection-method {
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .connection-method.available {
            border-color: #2ecc71;
            background: #e8f5e8;
        }

        .connection-method.unavailable {
            border-color: #e74c3c;
            background: #fdf2f2;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .connection-method.active {
            border-color: #3498db;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .method-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .method-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .method-description {
            font-size: 0.9rem;
            color: #666;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .devices-grid {
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
        }

        .device-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            opacity: 0.6;
        }

        .device-card.receiving {
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            border: 2px solid #2ecc71;
        }

        .device-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .device-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .trainer .device-icon { background: linear-gradient(45deg, #ff6b6b, #ff8e8e); }
        .hrm .device-icon { background: linear-gradient(45deg, #a8e6cf, #7fcdcd); }

        .device-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .device-status {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-active { background-color: #2ecc71; }
        .status-inactive { background-color: #e74c3c; }
        .status-searching { background-color: #f39c12; animation: pulse 1s infinite; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        @media (min-width: 768px) {
            .metrics {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 10px;
            }
        }

        .metric {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .metric.updated {
            background: #d4edda;
            transform: scale(1.05);
        }

        .metric-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
        }

        @media (min-width: 768px) {
            .metric-value {
                font-size: 1.6rem;
            }
        }

        .metric-label {
            font-size: 0.7rem;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
            margin: 5px 0;
        }

        .btn:hover {
            background: linear-gradient(45deg, #2980b9, #1f639a);
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-scan {
            background: linear-gradient(45deg, #27ae60, #229954);
        }

        .btn-stop {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .wahoo-controls {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .wahoo-device-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
        }

        .wahoo-device {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .wahoo-device:hover {
            background: #f8f9fa;
        }

        .wahoo-device:last-child {
            border-bottom: none;
        }

        .device-info {
            flex: 1;
        }

        .device-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .device-details {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .connect-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .log-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .log-content {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .hr-zone {
            text-align: center;
            margin: 10px 0;
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .zone-1 { background: #e8f5e8; color: #27ae60; }
        .zone-2 { background: #fff3cd; color: #f39c12; }
        .zone-3 { background: #ffeaa7; color: #fdcb6e; }
        .zone-4 { background: #fab1a0; color: #e17055; }
        .zone-5 { background: #fd79a8; color: #e84393; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì° Cross-Platform ANT+ Receiver</h1>
            <p>Android, Windows, Mac & iOS Compatible</p>
        </div>

        <div class="platform-info">
            <div class="platform-detected" id="platform-detected">üîç Detecting platform...</div>
            <div id="platform-capabilities">Checking connection capabilities...</div>
        </div>

        <div class="connection-panel">
            <h3>üîó Connection Methods</h3>
            <div class="connection-options">
                <!-- USB ANT+ Method -->
                <div class="connection-method" id="usb-method">
                    <div class="method-icon">üîå</div>
                    <div class="method-title">USB ANT+ Stick</div>
                    <div class="method-description">Direct USB connection (Windows/Mac/Linux)</div>
                    <button class="btn" id="usb-connect-btn" onclick="connectUSB()" disabled>Connect USB</button>
                </div>

                <!-- Bluetooth ANT+ Method -->
                <div class="connection-method" id="bluetooth-method">
                    <div class="method-icon">üì±</div>
                    <div class="method-title">Bluetooth ANT+</div>
                    <div class="method-description">Bluetooth Low Energy (Android/iOS/Modern browsers)</div>
                    <button class="btn" id="bluetooth-connect-btn" onclick="connectBluetooth()" disabled>Scan Bluetooth</button>
                </div>
            </div>

            <!-- Wahoo Trainer Specific Controls -->
            <div class="wahoo-controls" id="wahoo-controls" style="display: none;">
                <h4>üö¥ Wahoo Trainer Connection</h4>
                <p>Connect directly to your Wahoo trainer via Bluetooth:</p>
                <button class="btn btn-scan" onclick="scanWahooTrainers()">Scan for Wahoo Trainers</button>
                <div class="wahoo-device-list" id="wahoo-device-list" style="display: none;">
                    <div style="padding: 20px; text-align: center; color: #666;">
                        Scanning for Wahoo trainers...
                    </div>
                </div>
            </div>

            <div id="connection-status" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;">
                <strong>Status:</strong> <span id="status-text">Disconnected</span>
            </div>
        </div>

        <div class="devices-grid">
            <!-- Trainer Card -->
            <div class="device-card trainer" id="trainer-card">
                <div class="device-header">
                    <div class="device-icon">üö¥</div>
                    <div>
                        <div class="device-title">Fitness Equipment</div>
                        <div class="device-status">
                            <span class="status-indicator" id="trainer-status"></span>
                            <span id="trainer-status-text">No Signal</span>
                        </div>
                    </div>
                </div>

                <div class="metrics">
                    <div class="metric" id="power-metric">
                        <div class="metric-value" id="power-value">---</div>
                        <div class="metric-label">Power (W)</div>
                    </div>
                    <div class="metric" id="resistance-metric">
                        <div class="metric-value" id="resistance-value">---</div>
                        <div class="metric-label">Resistance (%)</div>
                    </div>
                    <div class="metric" id="cadence-metric">
                        <div class="metric-value" id="cadence-value">---</div>
                        <div class="metric-label">Cadence (RPM)</div>
                    </div>
                    <div class="metric" id="speed-metric">
                        <div class="metric-value" id="speed-value">---</div>
                        <div class="metric-label">Speed (km/h)</div>
                    </div>
                    <div class="metric" id="distance-metric">
                        <div class="metric-value" id="distance-value">---</div>
                        <div class="metric-label">Distance (km)</div>
                    </div>
                    <div class="metric" id="time-metric">
                        <div class="metric-value" id="time-value">---</div>
                        <div class="metric-label">Time</div>
                    </div>
                </div>

                <div id="trainer-last-update" style="text-align: center; font-size: 0.8rem; color: #666;">
                    Waiting for data...
                </div>
            </div>

            <!-- Heart Rate Monitor Card -->
            <div class="device-card hrm" id="hrm-card">
                <div class="device-header">
                    <div class="device-icon">‚ù§Ô∏è</div>
                    <div>
                        <div class="device-title">Heart Rate Monitor</div>
                        <div class="device-status">
                            <span class="status-indicator" id="hrm-status"></span>
                            <span id="hrm-status-text">No Signal</span>
                        </div>
                    </div>
                </div>

                <div class="metrics">
                    <div class="metric" id="hr-metric">
                        <div class="metric-value" id="hr-value">---</div>
                        <div class="metric-label">BPM</div>
                    </div>
                    <div class="metric" id="hr-avg-metric">
                        <div class="metric-value" id="hr-avg">---</div>
                        <div class="metric-label">Avg BPM</div>
                    </div>
                    <div class="metric" id="hr-max-metric">
                        <div class="metric-value" id="hr-max">---</div>
                        <div class="metric-label">Max BPM</div>
                    </div>
                </div>

                <div class="hr-zone" id="hr-zone">Zone Unknown</div>

                <div id="hrm-last-update" style="text-align: center; font-size: 0.8rem; color: #666;">
                    Waiting for data...
                </div>
            </div>
        </div>

        <!-- Log Section -->
        <div class="log-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>üìã Connection Log</h3>
                <button onclick="clearLog()" style="background: #95a5a6; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Clear</button>
            </div>
            <div class="log-content" id="log-content"></div>
        </div>
    </div>

    <script>
        let currentConnection = null;
        let platform = null;
        let connectedDevices = new Map();
        let sessionData = {
            trainer: { distance: 0, startTime: null, maxPower: 0 },
            hrm: { avgHR: 0, maxHR: 0, hrHistory: [] }
        };

        // Platform detection
        function detectPlatform() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isMobile = /android|iphone|ipad|ipod|blackberry|iemobile|opera mini/.test(userAgent);
            const isAndroid = /android/.test(userAgent);
            const isIOS = /iphone|ipad|ipod/.test(userAgent);
            const isWindows = /windows/.test(userAgent);
            const isMac = /macintosh|mac os x/.test(userAgent);
            const isLinux = /linux/.test(userAgent);

            let platformName = 'Unknown';
            if (isAndroid) platformName = 'Android';
            else if (isIOS) platformName = 'iOS';
            else if (isWindows) platformName = 'Windows';
            else if (isMac) platformName = 'macOS';
            else if (isLinux) platformName = 'Linux';

            platform = {
                name: platformName,
                isMobile: isMobile,
                isAndroid: isAndroid,
                isIOS: isIOS,
                hasWebSerial: 'serial' in navigator,
                hasWebBluetooth: 'bluetooth' in navigator,
                hasWebUSB: 'usb' in navigator
            };

            updatePlatformDisplay();
            updateConnectionMethods();
        }

        function updatePlatformDisplay() {
            const platformElement = document.getElementById('platform-detected');
            const capabilitiesElement = document.getElementById('platform-capabilities');
            
            platformElement.textContent = `üì± Platform: ${platform.name}`;
            
            let capabilities = [];
            if (platform.hasWebSerial) capabilities.push('USB ANT+');
            if (platform.hasWebBluetooth) capabilities.push('Bluetooth');
            if (platform.hasWebUSB) capabilities.push('WebUSB');
            
            if (capabilities.length > 0) {
                capabilitiesElement.textContent = `‚úÖ Available: ${capabilities.join(', ')}`;
                capabilitiesElement.style.color = '#27ae60';
            } else {
                capabilitiesElement.textContent = '‚ùå Limited connectivity options available';
                capabilitiesElement.style.color = '#e74c3c';
            }
        }

        function updateConnectionMethods() {
            const usbMethod = document.getElementById('usb-method');
            const bluetoothMethod = document.getElementById('bluetooth-method');
            const usbBtn = document.getElementById('usb-connect-btn');
            const bluetoothBtn = document.getElementById('bluetooth-connect-btn');
            
            // USB ANT+ Method
            if (platform.hasWebSerial && !platform.isMobile) {
                usbMethod.classList.add('available');
                usbBtn.disabled = false;
                log('‚úÖ USB ANT+ stick connection available');
            } else {
                usbMethod.classList.add('unavailable');
                usbBtn.disabled = true;
                if (platform.isMobile) {
                    log('‚ÑπÔ∏è USB ANT+ not available on mobile devices');
                } else {
                    log('‚ùå Web Serial API not supported in this browser');
                }
            }
            
            // Bluetooth Method
            if (platform.hasWebBluetooth) {
                bluetoothMethod.classList.add('available');
                bluetoothBtn.disabled = false;
                document.getElementById('wahoo-controls').style.display = 'block';
                log('‚úÖ Bluetooth ANT+ connection available');
            } else {
                bluetoothMethod.classList.add('unavailable');
                bluetoothBtn.disabled = true;
                log('‚ùå Web Bluetooth API not supported');
            }
        }

        // USB Connection (Desktop)
        async function connectUSB() {
            if (!platform.hasWebSerial) {
                alert('Web Serial API not supported on this platform');
                return;
            }

            try {
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 57600 });
                
                currentConnection = {
                    type: 'usb',
                    port: port,
                    reader: null
                };
                
                updateConnectionStatus('Connected via USB ANT+', 'success');
                log('üîå USB ANT+ stick connected successfully');
                
                // Start listening for data
                startUSBListening();
                
            } catch (error) {
                log(`‚ùå USB connection failed: ${error.message}`);
                updateConnectionStatus('USB connection failed', 'error');
            }
        }

        async function startUSBListening() {
            if (!currentConnection || currentConnection.type !== 'usb') return;
            
            try {
                const reader = currentConnection.port.readable.getReader();
                currentConnection.reader = reader;
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    processANTData(value);
                }
            } catch (error) {
                log(`‚ùå USB reading error: ${error.message}`);
            }
        }

        // Bluetooth Connection (Mobile/Cross-platform)
        async function connectBluetooth() {
            if (!platform.hasWebBluetooth) {
                alert('Web Bluetooth API not supported on this platform');
                return;
            }

            try {
                log('üîç Scanning for Bluetooth devices...');
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: ['heart_rate'] },
                        { services: ['cycling_power'] },
                        { services: ['cycling_speed_and_cadence'] },
                        { services: ['fitness_equipment'] }
                    ],
                    optionalServices: [
                        'device_information',
                        'battery_service',
                        'generic_access'
                    ]
                });

                log(`üì± Found device: ${device.name || 'Unknown'}`);
                
                const server = await device.gatt.connect();
                
                currentConnection = {
                    type: 'bluetooth',
                    device: device,
                    server: server
                };
                
                updateConnectionStatus(`Connected to ${device.name || 'Bluetooth Device'}`, 'success');
                
                // Start monitoring services
                await startBluetoothMonitoring();
                
            } catch (error) {
                log(`‚ùå Bluetooth connection failed: ${error.message}`);
                updateConnectionStatus('Bluetooth connection failed', 'error');
            }
        }

        async function startBluetoothMonitoring() {
            if (!currentConnection || currentConnection.type !== 'bluetooth') return;
            
            try {
                const server = currentConnection.server;
                
                // Monitor Heart Rate
                try {
                    const hrService = await server.getPrimaryService('heart_rate');
                    const hrCharacteristic = await hrService.getCharacteristic('heart_rate_measurement');
                    await hrCharacteristic.startNotifications();
                    hrCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRateData);
                    log('‚ù§Ô∏è Heart Rate monitoring started');
                } catch (e) {
                    log('‚ÑπÔ∏è Heart Rate service not available');
                }
                
                // Monitor Cycling Power
                try {
                    const powerService = await server.getPrimaryService('cycling_power');
                    const powerCharacteristic = await powerService.getCharacteristic('cycling_power_measurement');
                    await powerCharacteristic.startNotifications();
                    powerCharacteristic.addEventListener('characteristicvaluechanged', handlePowerData);
                    log('‚ö° Power monitoring started');
                } catch (e) {
                    log('‚ÑπÔ∏è Cycling Power service not available');
                }
                
                // Monitor Speed/Cadence
                try {
                    const cscService = await server.getPrimaryService('cycling_speed_and_cadence');
                    const cscCharacteristic = await cscService.getCharacteristic('csc_measurement');
                    await cscCharacteristic.startNotifications();
                    cscCharacteristic.addEventListener('characteristicvaluechanged', handleSpeedCadenceData);
                    log('üö¥ Speed/Cadence monitoring started');
                } catch (e) {
                    log('‚ÑπÔ∏è Speed/Cadence service not available');
                }
                
            } catch (error) {
                log(`‚ùå Bluetooth monitoring setup failed: ${error.message}`);
            }
        }

        // Wahoo Trainer Specific Connection
        async function scanWahooTrainers() {
            if (!platform.hasWebBluetooth) {
                alert('Bluetooth not supported on this platform');
                return;
            }

            try {
                log('üîç Scanning specifically for Wahoo trainers...');
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: 'KICKR' },
                        { namePrefix: 'SNAP' },
                        { namePrefix: 'Wahoo' },
                        { services: ['fitness_equipment'] },
                        { services: ['cycling_power'] }
                    ],
                    optionalServices: [
                        'fitness_equipment',
                        'cycling_power',
                        'cycling_speed_and_cadence',
                        'device_information',
                        '6e40fec1-b5a3-f393-e0a9-e50e24dcca9e' // Wahoo custom service
                    ]
                });

                log(`üö¥ Found Wahoo trainer: ${device.name}`);
                
                const server = await device.gatt.connect();
                
                currentConnection = {
                    type: 'wahoo',
                    device: device,
                    server: server
                };
                
                updateConnectionStatus(`Connected to ${device.name}`, 'success');
                
                // Start Wahoo-specific monitoring
                await startWahooMonitoring();
                
            } catch (error) {
                log(`‚ùå Wahoo trainer connection failed: ${error.message}`);
                updateConnectionStatus('Wahoo connection failed', 'error');
            }
        }

        async function startWahooMonitoring() {
            if (!currentConnection || currentConnection.type !== 'wahoo') return;
            
            try {
                const server = currentConnection.server;
                
                // Wahoo Fitness Equipment Service
                try {
                    const ftmsService = await server.getPrimaryService('fitness_equipment');
                    const ftmsCharacteristic = await ftmsService.getCharacteristic('indoor_bike_data');
                    await ftmsCharacteristic.startNotifications();
                    ftmsCharacteristic.addEventListener('characteristicvaluechanged', handleWahooTrainerData);
                    log('üö¥ Wahoo trainer data monitoring started');
                } catch (e) {
                    log('‚ö†Ô∏è Wahoo FTMS service not available, trying power service');
                }
                
                // Fallback to Power Service
                try {
                    const powerService = await server.getPrimaryService('cycling_power');
                    const powerCharacteristic = await powerService.getCharacteristic('cycling_power_measurement');
                    await powerCharacteristic.startNotifications();
                    powerCharacteristic.addEventListener('characteristicvaluechanged', handlePowerData);
                    log('‚ö° Wahoo power data monitoring started');
                } catch (e) {
                    log('‚ÑπÔ∏è Power service also not available');
                }
                
            } catch (error) {
                log(`‚ùå Wahoo monitoring setup failed: ${error.message}`);
            }
        }

        // Data Handlers
        function handleHeartRateData(event) {
            const value = event.target.value;
            const heartRate = value.getUint8(1);
            
            updateHRMMetrics({
                heartRate: heartRate,
                source: 'bluetooth'
            });
            
            log(`‚ù§Ô∏è HR: ${heartRate} BPM`);
        }

        function handlePowerData(event) {
            const value = event.target.value;
            const flags = value.getUint16(0, true);
            const power = value.getUint16(2, true);
            
            // Extract cadence if available
            let cadence = 0;
            if (flags & 0x20 && value.byteLength >= 6) { // Crank Revolution Data Present
                cadence = value.getUint8(5); // Simplified cadence extraction
            }
            
            updateTrainerMetrics({
                power: power,
                cadence: cadence,
                speed: (power / 10).toFixed(1),
                resistance: Math.round(power / 20),
                source: 'bluetooth'
            });
            
            log(`‚ö° Power: ${power}W, Cadence: ${cadence}RPM`);
        }

        function handleSpeedCadenceData(event) {
            const value = event.target.value;
            const flags = value.getUint8(0);
            
            let cadence = 0, speed = 0;
            
            if (flags & 0x01) { // Wheel Revolution Data Present
                const wheelRevs = value.getUint32(1, true);
                const wheelTime = value.getUint16(5, true);
                speed = (wheelRevs * 2.1 * 3.6 / 1000).toFixed(1); // Rough calculation
            }
            
            if (flags & 0x02) { // Crank Revolution Data Present
                const crankRevs = value.getUint16(7, true);
                const crankTime = value.getUint16(9, true);
                cadence = Math.round(crankRevs / 60); // Simplified
            }
            
            updateTrainerMetrics({
                power: 0,
                cadence: cadence,
                speed: speed,
                resistance: 0,
                source: 'bluetooth'
            });
            
            log(`üö¥ Speed: ${speed}km/h, Cadence: ${cadence}RPM`);
        }

        function handleWahooTrainerData(event) {
            const value = event.target.value;
            
            // Parse Wahoo FTMS indoor bike data
            const flags = value.getUint16(0, true);
            let offset = 2;
            
            let power = 0, cadence = 0, speed = 0, resistance = 0;
            
            // More data available (flags indicate which fields are present)
            if (flags & 0x01) { // More data
                speed = value.getUint16(offset, true) / 100; // km/h
                offset += 2;
            }
            
            if (flags & 0x04) { // Average speed
                offset += 2; // Skip
            }
            
            if (flags & 0x08) { // Instantaneous cadence
                cadence = value.getUint16(offset, true) / 2;
                offset += 2;
            }
            
            if (flags & 0x40) { // Instantaneous power
                power = value.getInt16(offset, true);
                offset += 2;
            }
            
            if (flags & 0x200) { // Resistance level
                resistance = value.getInt16(offset, true);
                offset += 2;
            }
            
            updateTrainerMetrics({
                power: power,
                cadence: cadence,
                speed: speed.toFixed(1),
                resistance: resistance,
                source: 'wahoo'
            });
            
            log(`üö¥ Wahoo: ${power}W, ${cadence}RPM, ${speed.toFixed(1)}km/h, ${resistance}% resistance`);
        }

        function processANTData(data) {
            // Process USB ANT+ data (same as previous implementation)
            const hexData = Array.from(data).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
            log(`üì• ANT+ RX: ${hexData}`);
            
            // Parse ANT+ messages and extract data
            // (Implementation similar to previous receiver)
        }

        // UI Update Functions
        function updateTrainerMetrics(data) {
            document.getElementById('power-value').textContent = data.power || '---';
            document.getElementById('cadence-value').textContent = data.cadence || '---';
            document.getElementById('speed-value').textContent = data.speed || '---';
            document.getElementById('resistance-value').textContent = data.resistance || '---';
            
            // Calculate distance and time
            if (!sessionData.trainer.startTime) {
                sessionData.trainer.startTime = Date.now();
            }
            
            const elapsedTime = Date.now() - sessionData.trainer.startTime;
            const speedKmh = parseFloat(data.speed) || 0;
            sessionData.trainer.distance += speedKmh * (1000 / 3600000); // 1 second interval
            
            document.getElementById('distance-value').textContent = sessionData.trainer.distance.toFixed(2);
            document.getElementById('time-value').textContent = formatTime(elapsedTime);
            
            updateDeviceStatus('trainer', 'receiving');
            animateMetricUpdate('power-metric');
            document.getElementById('trainer-last-update').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
        }

        function updateHRMMetrics(data) {
            document.getElementById('hr-value').textContent = data.heartRate;
            
            // Calculate running average
            sessionData.hrm.hrHistory.push(data.heartRate);
            if (sessionData.hrm.hrHistory.length > 20) {
                sessionData.hrm.hrHistory.shift();
            }
            
            const avgHR = sessionData.hrm.hrHistory.reduce((a, b) => a + b, 0) / sessionData.hrm.hrHistory.length;
            document.getElementById('hr-avg').textContent = Math.round(avgHR);
            
            if (data.heartRate > sessionData.hrm.maxHR) {
                sessionData.hrm.maxHR = data.heartRate;
            }
            document.getElementById('hr-max').textContent = sessionData.hrm.maxHR;
            
            updateHRZone(data.heartRate);
            updateDeviceStatus('hrm', 'receiving');
            animateMetricUpdate('hr-metric');
            document.getElementById('hrm-last-update').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
        }

        function updateHRZone(heartRate) {
            const maxHR = 185;
            const zoneElement = document.getElementById('hr-zone');
            
            const zones = [
                { max: 0.6, name: 'Zone 1 - Recovery', class: 'zone-1' },
                { max: 0.7, name: 'Zone 2 - Aerobic Base', class: 'zone-2' },
                { max: 0.8, name: 'Zone 3 - Aerobic', class: 'zone-3' },
                { max: 0.9, name: 'Zone 4 - Threshold', class: 'zone-4' },
                { max: 1.0, name: 'Zone 5 - VO2 Max', class: 'zone-5' }
            ];
            
            const hrPercent = heartRate / maxHR;
            let currentZone = zones[zones.length - 1];
            
            for (let zone of zones) {
                if (hrPercent <= zone.max) {
                    currentZone = zone;
                    break;
                }
            }
            
            zoneElement.textContent = currentZone.name;
            zoneElement.className = `hr-zone ${currentZone.class}`;
        }

        function updateDeviceStatus(device, status) {
            const statusIndicator = document.getElementById(`${device}-status`);
            const statusText = document.getElementById(`${device}-status-text`);
            const card = document.getElementById(`${device}-card`);
            
            switch (status) {
                case 'receiving':
                    statusIndicator.className = 'status-indicator status-active';
                    statusText.textContent = 'Receiving Data';
                    card.classList.add('receiving');
                    break;
                case 'searching':
                    statusIndicator.className = 'status-indicator status-searching';
                    statusText.textContent = 'Searching...';
                    card.classList.remove('receiving');
                    break;
                default:
                    statusIndicator.className = 'status-indicator status-inactive';
                    statusText.textContent = 'No Signal';
                    card.classList.remove('receiving');
                    break;
            }
        }

        function updateConnectionStatus(message, type) {
            const statusDiv = document.getElementById('connection-status');
            const statusText = document.getElementById('status-text');
            
            statusDiv.style.display = 'block';
            statusText.textContent = message;
            
            if (type === 'success') {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
            } else {
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.style.border = '1px solid #ffeaa7';
            }
        }

        function animateMetricUpdate(metricId) {
            const metric = document.getElementById(metricId);
            metric.classList.add('updated');
            setTimeout(() => metric.classList.remove('updated'), 300);
        }

        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function log(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logContent.textContent += `[${timestamp}] ${message}\n`;
            logContent.scrollTop = logContent.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-content').textContent = '';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            detectPlatform();
            updateDeviceStatus('trainer', 'inactive');
            updateDeviceStatus('hrm', 'inactive');
            
            log('üöÄ Cross-platform ANT+ receiver initialized');
            log(`üì± Platform: ${platform.name}`);
            
            // Monitor for device disconnections
            if (platform.hasWebBluetooth) {
                navigator.bluetooth.addEventListener('advertisementreceived', (event) => {
                    log(`üì° Advertisement from ${event.device.name}: ${event.rssi} dBm`);
                });
            }
        });

        // Monitor connection status
        setInterval(() => {
            if (currentConnection && currentConnection.type === 'bluetooth') {
                if (!currentConnection.device.gatt.connected) {
                    log('‚ö†Ô∏è Bluetooth device disconnected');
                    updateConnectionStatus('Device disconnected', 'error');
                    currentConnection = null;
                }
            }
        }, 5000);
    </script>
</body>
</html>