<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANT+ Device Receiver</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .connection-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .usb-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #2ecc71;
        }

        .status-dot.scanning {
            background: #f39c12;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .scanning-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .device-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            opacity: 0.6;
        }

        .device-card.receiving {
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            border: 2px solid #2ecc71;
        }

        .device-card.no-signal {
            border: 2px solid #e74c3c;
        }

        .device-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .device-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .trainer .device-icon { background: linear-gradient(45deg, #ff6b6b, #ff8e8e); }
        .shifter .device-icon { background: linear-gradient(45deg, #4ecdc4, #45b7aa); }
        .hrm .device-icon { background: linear-gradient(45deg, #a8e6cf, #7fcdcd); }

        .device-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .device-status {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .signal-strength {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }

        .signal-bar {
            width: 4px;
            height: 12px;
            background: #bdc3c7;
            border-radius: 2px;
        }

        .signal-bar.active {
            background: #2ecc71;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active { background-color: #2ecc71; }
        .status-inactive { background-color: #e74c3c; }
        .status-searching { background-color: #f39c12; animation: pulse 1s infinite; }

        .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .metric {
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .metric.updated {
            background: #d4edda;
            transform: scale(1.05);
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .ant-info {
            background: #ecf0f1;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .ant-channel {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .last-update {
            font-size: 0.8rem;
            color: #95a5a6;
            text-align: center;
            margin-top: 10px;
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: linear-gradient(45deg, #2980b9, #1f639a);
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-scan {
            background: linear-gradient(45deg, #27ae60, #229954);
        }

        .btn-scan:hover {
            background: linear-gradient(45deg, #229954, #1e8449);
        }

        .btn-stop {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .btn-stop:hover {
            background: linear-gradient(45deg, #c0392b, #a93226);
        }

        .btn-usb {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
        }

        .btn-usb:hover {
            background: linear-gradient(45deg, #8e44ad, #7d3c98);
        }

        .log-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .log-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .clear-log {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .log-content {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .protocol-info {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .protocol-info h3 {
            color: #2980b9;
            margin-bottom: 10px;
        }

        .hex-display {
            font-family: 'Courier New', monospace;
            background: #34495e;
            color: #ecf0f1;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 5px 0;
        }

        .gear-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .gear-display {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            background: #ecf0f1;
            padding: 10px 20px;
            border-radius: 10px;
            min-width: 80px;
            text-align: center;
        }

        .hr-zone {
            text-align: center;
            margin: 10px 0;
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
        }

        .zone-1 { background: #e8f5e8; color: #27ae60; }
        .zone-2 { background: #fff3cd; color: #f39c12; }
        .zone-3 { background: #ffeaa7; color: #fdcb6e; }
        .zone-4 { background: #fab1a0; color: #e17055; }
        .zone-5 { background: #fd79a8; color: #e84393; }

        .device-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .device-list h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .discovered-device {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 5px;
            background: white;
        }

        .discovered-device:hover {
            background: #e9ecef;
        }

        .device-info {
            flex: 1;
        }

        .device-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .device-details {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .connect-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .connect-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì° ANT+ Device Receiver</h1>
            <p>Real ANT+ Signal Reception and Monitoring</p>
        </div>

        <div class="protocol-info">
            <h3>üîç ANT+ Protocol Receiver</h3>
            <p>This receiver listens for real ANT+ signals using the Web Serial API. Connect an ANT+ USB stick to receive signals from trainers, heart rate monitors, and other ANT+ devices.</p>
            <p><strong>Perfect for:</strong> Testing your virtual trainer emulator, monitoring real devices, or developing ANT+ applications.</p>
        </div>

        <!-- Connection Panel -->
        <div class="connection-panel">
            <div class="connection-status">
                <div class="usb-status">
                    <div class="status-dot" id="usb-status-dot"></div>
                    <span id="usb-status-text">ANT+ USB Stick: Disconnected</span>
                </div>
                <button class="btn btn-usb" id="connect-btn" onclick="connectANTStick()">Connect ANT+ USB</button>
            </div>
            <div id="ant-stick-info" style="display: none;">
                <strong>Connected Device:</strong> <span id="device-name"></span><br>
                <strong>ANT+ Network Key:</strong> <span class="hex-display" id="network-key">B9 A5 21 FB BD 72 C3 45</span>
            </div>
            <div class="scanning-controls" id="scanning-controls" style="display: none;">
                <button class="btn btn-scan" id="scan-btn" onclick="startScanning()">Start Scanning</button>
                <button class="btn btn-stop" id="stop-btn" onclick="stopScanning()" disabled>Stop Scanning</button>
                <button class="btn" onclick="clearDevices()">Clear Devices</button>
            </div>
            <div class="device-list" id="discovered-devices" style="display: none;">
                <h4>üìã Discovered Devices</h4>
                <div id="device-list-content">No devices discovered yet...</div>
            </div>
        </div>

        <div class="devices-grid">
            <!-- Trainer Card -->
            <div class="device-card trainer" id="trainer-card">
                <div class="device-header">
                    <div class="device-icon">üö¥</div>
                    <div>
                        <div class="device-title">Fitness Equipment (FE-C)</div>
                        <div class="device-status">
                            <span class="status-indicator" id="trainer-status"></span>
                            <span id="trainer-status-text">No Signal</span>
                        </div>
                        <div class="signal-strength">
                            <span style="font-size: 0.8rem; margin-right: 5px;">Signal:</span>
                            <div class="signal-bar" id="trainer-signal-1"></div>
                            <div class="signal-bar" id="trainer-signal-2"></div>
                            <div class="signal-bar" id="trainer-signal-3"></div>
                            <div class="signal-bar" id="trainer-signal-4"></div>
                            <div class="signal-bar" id="trainer-signal-5"></div>
                        </div>
                    </div>
                </div>

                <div class="ant-info">
                    <div class="ant-channel">
                        <span>Device Type:</span>
                        <span id="trainer-device-type">FE-C (0x11)</span>
                    </div>
                    <div class="ant-channel">
                        <span>Device ID:</span>
                        <span id="trainer-device-id">---</span>
                    </div>
                    <div class="ant-channel">
                        <span>Channel:</span>
                        <span id="trainer-channel">---</span>
                    </div>
                    <div class="ant-channel">
                        <span>Data Rate:</span>
                        <span id="trainer-data-rate">-- Hz</span>
                    </div>
                </div>

                <div class="metrics">
                    <div class="metric" id="power-metric">
                        <div class="metric-value" id="power-value">---</div>
                        <div class="metric-label">Power (W)</div>
                    </div>
                    <div class="metric" id="resistance-metric">
                        <div class="metric-value" id="resistance-value">---</div>
                        <div class="metric-label">Resistance (%)</div>
                    </div>
                    <div class="metric" id="cadence-metric">
                        <div class="metric-value" id="cadence-value">---</div>
                        <div class="metric-label">Cadence (RPM)</div>
                    </div>
                    <div class="metric" id="speed-metric">
                        <div class="metric-value" id="speed-value">---</div>
                        <div class="metric-label">Speed (km/h)</div>
                    </div>
                    <div class="metric" id="distance-metric">
                        <div class="metric-value" id="distance-value">---</div>
                        <div class="metric-label">Distance (km)</div>
                    </div>
                    <div class="metric" id="time-metric">
                        <div class="metric-value" id="time-value">---</div>
                        <div class="metric-label">Time</div>
                    </div>
                </div>

                <div class="last-update" id="trainer-last-update">Waiting for data...</div>
            </div>

            <!-- Shifter Card -->
            <div class="device-card shifter" id="shifter-card">
                <div class="device-header">
                    <div class="device-icon">‚öôÔ∏è</div>
                    <div>
                        <div class="device-title">Shifting System</div>
                        <div class="device-status">
                            <span class="status-indicator" id="shifter-status"></span>
                            <span id="shifter-status-text">No Signal</span>
                        </div>
                        <div class="signal-strength">
                            <span style="font-size: 0.8rem; margin-right: 5px;">Signal:</span>
                            <div class="signal-bar" id="shifter-signal-1"></div>
                            <div class="signal-bar" id="shifter-signal-2"></div>
                            <div class="signal-bar" id="shifter-signal-3"></div>
                            <div class="signal-bar" id="shifter-signal-4"></div>
                            <div class="signal-bar" id="shifter-signal-5"></div>
                        </div>
                    </div>
                </div>

                <div class="ant-info">
                    <div class="ant-channel">
                        <span>Device Type:</span>
                        <span id="shifter-device-type">Shifting (0x22)</span>
                    </div>
                    <div class="ant-channel">
                        <span>Device ID:</span>
                        <span id="shifter-device-id">---</span>
                    </div>
                    <div class="ant-channel">
                        <span>Channel:</span>
                        <span id="shifter-channel">---</span>
                    </div>
                    <div class="ant-channel">
                        <span>Data Rate:</span>
                        <span id="shifter-data-rate">-- Hz</span>
                    </div>
                </div>

                <div class="gear-indicator">
                    <div class="gear-display" id="gear-display">---</div>
                </div>

                <div class="metrics">
                    <div class="metric" id="front-gear-metric">
                        <div class="metric-value" id="front-gear">---</div>
                        <div class="metric-label">Front (T)</div>
                    </div>
                    <div class="metric" id="rear-gear-metric">
                        <div class="metric-value" id="rear-gear">---</div>
                        <div class="metric-label">Rear (T)</div>
                    </div>
                    <div class="metric" id="gear-ratio-metric">
                        <div class="metric-value" id="gear-ratio">---</div>
                        <div class="metric-label">Ratio</div>
                    </div>
                </div>

                <div class="last-update" id="shifter-last-update">Waiting for data...</div>
            </div>

            <!-- Heart Rate Monitor Card -->
            <div class="device-card hrm" id="hrm-card">
                <div class="device-header">
                    <div class="device-icon">‚ù§Ô∏è</div>
                    <div>
                        <div class="device-title">Heart Rate Monitor</div>
                        <div class="device-status">
                            <span class="status-indicator" id="hrm-status"></span>
                            <span id="hrm-status-text">No Signal</span>
                        </div>
                        <div class="signal-strength">
                            <span style="font-size: 0.8rem; margin-right: 5px;">Signal:</span>
                            <div class="signal-bar" id="hrm-signal-1"></div>
                            <div class="signal-bar" id="hrm-signal-2"></div>
                            <div class="signal-bar" id="hrm-signal-3"></div>
                            <div class="signal-bar" id="hrm-signal-4"></div>
                            <div class="signal-bar" id="hrm-signal-5"></div>
                        </div>
                    </div>
                </div>

                <div class="ant-info">
                    <div class="ant-channel">
                        <span>Device Type:</span>
                        <span id="hrm-device-type">Heart Rate (0x78)</span>
                    </div>
                    <div class="ant-channel">
                        <span>Device ID:</span>
                        <span id="hrm-device-id">---</span>
                    </div>
                    <div class="ant-channel">
                        <span>Channel:</span>
                        <span id="hrm-channel">---</span>
                    </div>
                    <div class="ant-channel">
                        <span>Data Rate:</span>
                        <span id="hrm-data-rate">-- Hz</span>
                    </div>
                </div>

                <div class="metrics">
                    <div class="metric" id="hr-metric">
                        <div class="metric-value" id="hr-value">---</div>
                        <div class="metric-label">BPM</div>
                    </div>
                    <div class="metric" id="hr-avg-metric">
                        <div class="metric-value" id="hr-avg">---</div>
                        <div class="metric-label">Avg BPM</div>
                    </div>
                    <div class="metric" id="hr-max-metric">
                        <div class="metric-value" id="hr-max">---</div>
                        <div class="metric-label">Max BPM</div>
                    </div>
                </div>

                <div class="hr-zone" id="hr-zone">Zone Unknown</div>

                <div class="last-update" id="hrm-last-update">Waiting for data...</div>
            </div>
        </div>

        <!-- Log Section -->
        <div class="log-section">
            <div class="log-header">
                <h2 class="log-title">üì• ANT+ Reception Log</h2>
                <button class="clear-log" onclick="clearLog()">Clear Log</button>
            </div>
            <div class="log-content" id="log-content"></div>
        </div>
    </div>

    <script>
        // ANT+ Protocol Constants
        const ANT_SYNC_BYTE = 0xA4;
        const ANT_MESSAGE_TYPES = {
            ASSIGN_CHANNEL: 0x42,
            CHANNEL_ID: 0x51,
            CHANNEL_PERIOD: 0x43,
            CHANNEL_RF_FREQ: 0x45,
            OPEN_CHANNEL: 0x4B,
            CLOSE_CHANNEL: 0x4C,
            BROADCAST_DATA: 0x4E,
            SET_NETWORK_KEY: 0x46,
            RESET_SYSTEM: 0x4A,
            CHANNEL_RESPONSE: 0x40
        };

        const ANT_DEVICE_TYPES = {
            HEART_RATE: 0x78,
            FEC_TRAINER: 0x11,
            SHIFTING: 0x22
        };

        // Receiver state
        let antStick = null;
        let isConnected = false;
        let isScanning = false;
        let reader = null;
        let receivedDevices = {};
        let lastDataTimes = {};
        let sessionData = {
            trainer: { distance: 0, startTime: null, maxPower: 0 },
            hrm: { avgHR: 0, maxHR: 0, hrHistory: [] }
        };

        // Device detection and data parsing
        async function connectANTStick() {
            if (!('serial' in navigator)) {
                alert('Web Serial API not supported. Please use Chrome or Edge browser.');
                return;
            }

            try {
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 57600 });

                antStick = port;
                isConnected = true;
                
                updateConnectionStatus(true);
                
                // Initialize ANT+ stick for receiving
                await initializeANTReceiver();
                
                log('‚úÖ ANT+ USB receiver connected successfully');
                log('üîß Initializing ANT+ receiver protocol...');
                
                // Start listening for incoming data
                startListening();
                
            } catch (error) {
                log(`‚ùå Failed to connect ANT+ receiver: ${error.message}`);
                updateConnectionStatus(false);
            }
        }

        async function initializeANTReceiver() {
            try {
                // Reset ANT+ stick
                await sendANTMessage(ANT_MESSAGE_TYPES.RESET_SYSTEM, []);
                await sleep(500);

                // Set network key (ANT+ Sport key)
                const networkKey = [0xB9, 0xA5, 0x21, 0xFB, 0xBD, 0x72, 0xC3, 0x45];
                await sendANTMessage(ANT_MESSAGE_TYPES.SET_NETWORK_KEY, [0x00, ...networkKey]);
                
                log('üóùÔ∏è ANT+ receiver network key set');
                
            } catch (error) {
                log(`‚ùå ANT+ receiver initialization failed: ${error.message}`);
            }
        }

        async function startScanning() {
            if (!isConnected) {
                alert('Please connect ANT+ USB stick first');
                return;
            }

            isScanning = true;
            document.getElementById('scan-btn').disabled = true;
            document.getElementById('stop-btn').disabled = false;
            document.getElementById('usb-status-dot').classList.add('scanning');
            document.getElementById('usb-status-text').textContent = 'ANT+ USB Stick: Scanning...';
            
            log('üîç Starting device scan...');
            
            // Setup scanning channels for different device types
            await setupScanningChannels();
        }

        async function setupScanningChannels() {
            try {
                // Channel 0: Heart Rate Monitors (most common watch broadcast)
                await setupChannelForScanning(0, ANT_DEVICE_TYPES.HEART_RATE, 8070);
                await sleep(100);
                
                // Channel 1: FE-C Trainers
                await setupChannelForScanning(1, ANT_DEVICE_TYPES.FEC_TRAINER, 8192);
                await sleep(100);
                
                // Channel 2: Shifting Systems
                await setupChannelForScanning(2, ANT_DEVICE_TYPES.SHIFTING, 8192);
                await sleep(100);
                
                // Channel 3: Wildcard channel for any device type
                await setupWildcardChannel(3);
                await sleep(100);
                
                // Channel 4: Power meters (common on watches)
                await setupChannelForScanning(4, 0x0B, 8182); // Power meter
                await sleep(100);
                
                // Channel 5: Speed/Cadence (another common watch type)
                await setupChannelForScanning(5, 0x79, 8086); // Speed/Cadence
                await sleep(100);
                
                log('üì° All scanning channels opened - listening for devices...');
                log('üîç Enhanced scanning for watches with wildcard and power detection');
                
            } catch (error) {
                log(`‚ùå Channel setup failed: ${error.message}`);
            }
        }

        async function setupChannelForScanning(channel, deviceType, period) {
            // Assign channel as receive (slave)
            await sendANTMessage(ANT_MESSAGE_TYPES.ASSIGN_CHANNEL, [channel, 0x00, 0x00]);
            await sleep(50);

            // Set channel ID to accept any device of this type
            await sendANTMessage(ANT_MESSAGE_TYPES.CHANNEL_ID, [channel, 0x00, 0x00, deviceType, 0x00]);
            await sleep(50);

            // Set channel period
            const periodLow = period & 0xFF;
            const periodHigh = (period >> 8) & 0xFF;
            await sendANTMessage(ANT_MESSAGE_TYPES.CHANNEL_PERIOD, [channel, periodLow, periodHigh]);
            await sleep(50);

            // Set RF frequency (2457 MHz = 57)
            await sendANTMessage(ANT_MESSAGE_TYPES.CHANNEL_RF_FREQ, [channel, 57]);
            await sleep(50);

            // Open channel
            await sendANTMessage(ANT_MESSAGE_TYPES.OPEN_CHANNEL, [channel]);
            await sleep(50);
        }

        async function setupWildcardChannel(channel) {
            // Assign channel as receive (slave)
            await sendANTMessage(ANT_MESSAGE_TYPES.ASSIGN_CHANNEL, [channel, 0x00, 0x00]);
            await sleep(50);

            // Set channel ID to accept ANY device type (wildcard)
            await sendANTMessage(ANT_MESSAGE_TYPES.CHANNEL_ID, [channel, 0x00, 0x00, 0x00, 0x00]);
            await sleep(50);

            // Set channel period (generic)
            await sendANTMessage(ANT_MESSAGE_TYPES.CHANNEL_PERIOD, [channel, 0x00, 0x20]);
            await sleep(50);

            // Set RF frequency (2457 MHz = 57)
            await sendANTMessage(ANT_MESSAGE_TYPES.CHANNEL_RF_FREQ, [channel, 57]);
            await sleep(50);

            // Open channel
            await sendANTMessage(ANT_MESSAGE_TYPES.OPEN_CHANNEL, [channel]);
            await sleep(50);
        }

        async function stopScanning() {
            isScanning = false;
            document.getElementById('scan-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            document.getElementById('usb-status-dot').classList.remove('scanning');
            document.getElementById('usb-status-text').textContent = 'ANT+ USB Stick: Connected';
            
            // Close all channels (expanded to 6 channels)
            for (let i = 0; i < 6; i++) {
                try {
                    await sendANTMessage(ANT_MESSAGE_TYPES.CLOSE_CHANNEL, [i]);
                    await sleep(50);
                } catch (error) {
                    // Ignore close errors
                }
            }
            
            log('‚èπÔ∏è Scanning stopped');
        }

        async function startListening() {
            if (!antStick) return;
            
            try {
                reader = antStick.readable.getReader();
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    // Process incoming ANT+ data
                    processIncomingData(value);
                }
            } catch (error) {
                log(`‚ùå Reading error: ${error.message}`);
            } finally {
                if (reader) {
                    reader.releaseLock();
                }
            }
        }

        function processIncomingData(data) {
            // Convert to hex for logging
            const hexData = Array.from(data).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
            log(`üì• RX: ${hexData}`);
            
            // Parse ANT+ messages
            for (let i = 0; i < data.length; i++) {
                if (data[i] === ANT_SYNC_BYTE && i + 3 < data.length) {
                    const length = data[i + 1];
                    const messageType = data[i + 2];
                    
                    if (i + length + 4 <= data.length) {
                        const messageData = data.slice(i + 3, i + 3 + length);
                        
                        if (messageType === ANT_MESSAGE_TYPES.BROADCAST_DATA) {
                            parseBroadcastData(messageData);
                        } else if (messageType === ANT_MESSAGE_TYPES.CHANNEL_RESPONSE) {
                            // Log channel responses for debugging
                            const channel = messageData[0];
                            const messageId = messageData[1];
                            const response = messageData[2];
                            log(`üì° Channel ${channel} Response: MSG ${messageId.toString(16)} = ${response.toString(16)}`);
                        }
                        
                        i += length + 3; // Skip processed message
                    }
                }
            }
        }

        function parseBroadcastData(data) {
            if (data.length < 9) return;
            
            const channel = data[0];
            const payload = data.slice(1, 9);
            const dataPage = payload[0];
            
            // Log all received data for debugging
            const payloadHex = payload.map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
            log(`üîç CH${channel} Page 0x${dataPage.toString(16).padStart(2, '0')}: ${payloadHex}`);
            
            // Determine device type based on channel and data page
            let deviceType = null;
            let deviceName = 'Unknown';
            
            // Heart Rate (most common watch broadcast)
            if (dataPage === 0x00 || dataPage === 0x01 || dataPage === 0x02 || dataPage === 0x03 || dataPage === 0x04) {
                deviceType = 'hrm';
                deviceName = 'Heart Rate Monitor';
                parseHRMData(payload, channel);
            }
            // Power Meter data pages
            else if (dataPage === 0x10 || dataPage === 0x11 || dataPage === 0x12 || dataPage === 0x13) {
                deviceType = 'trainer';
                deviceName = 'Power Meter';
                parsePowerMeterData(payload, channel);
            }
            // FE-C Trainer
            else if (dataPage === 0x10 && payload.length >= 8) {
                deviceType = 'trainer';
                deviceName = 'FE-C Trainer';
                parseTrainerData(payload, channel);
            }
            // Shifting
            else if (dataPage === 0x22) {
                deviceType = 'shifter';
                deviceName = 'Shifting System';
                parseShifterData(payload, channel);
            }
            // Speed/Cadence
            else if (dataPage === 0x00 && channel >= 4) {
                deviceType = 'trainer';
                deviceName = 'Speed/Cadence Sensor';
                parseSpeedCadenceData(payload, channel);
            }
            // Unknown device - log for analysis
            else {
                log(`‚ùì Unknown device type - Page: 0x${dataPage.toString(16)}, Channel: ${channel}, Data: ${payloadHex}`);
                // Try to parse as generic data
                parseGenericData(payload, channel, dataPage);
                return;
            }
            
            if (deviceType) {
                updateLastDataTime(deviceType);
                updateDeviceStatus(deviceType, 'receiving');
                log(`‚úÖ Detected ${deviceName} on channel ${channel}`);
            }
        }

        function parseTrainerData(payload, channel) {
            if (payload[0] === 0x10) { // General FE-C data page
                const eventCount = payload[1];
                const cadence = payload[2];
                const power = payload[3] | (payload[4] << 8);
                
                // Calculate speed (simplified)
                const speed = power > 0 ? (power / 10) + Math.random() * 2 : 0;
                
                updateTrainerMetrics({
                    power: power,
                    cadence: cadence,
                    speed: speed.toFixed(1),
                    resistance: Math.round(power / 20), // Estimate
                    channel: channel,
                    deviceId: `${channel}-${eventCount % 1000}`
                });
                
                log(`üö¥ Trainer Data: ${power}W, ${cadence}RPM, ${speed.toFixed(1)}km/h`);
            }
        }

        function parseHRMData(payload, channel) {
            const dataPage = payload[0];
            
            // Standard HR data pages
            if (dataPage === 0x00 || dataPage === 0x01 || dataPage === 0x02 || dataPage === 0x03 || dataPage === 0x04) {
                let heartRate = 0;
                let eventCount = 0;
                
                if (dataPage === 0x00) {
                    // Page 0: Basic HR
                    heartRate = payload[6];
                    eventCount = payload[4] | (payload[5] << 8);
                } else if (dataPage === 0x01) {
                    // Page 1: Cumulative operating time
                    heartRate = payload[6];
                    eventCount = payload[4] | (payload[5] << 8);
                } else if (dataPage === 0x02) {
                    // Page 2: Manufacturer info
                    heartRate = payload[6];
                    eventCount = payload[4] | (payload[5] << 8);
                } else if (dataPage === 0x03) {
                    // Page 3: Product info
                    heartRate = payload[6];
                    eventCount = payload[4] | (payload[5] << 8);
                } else if (dataPage === 0x04) {
                    // Page 4: Previous heart beat info
                    heartRate = payload[6];
                    eventCount = payload[4] | (payload[5] << 8);
                }
                
                if (heartRate > 0 && heartRate < 255) {
                    updateHRMMetrics({
                        heartRate: heartRate,
                        channel: channel,
                        deviceId: `${channel}-${eventCount % 1000}`,
                        dataPage: dataPage
                    });
                    
                    log(`‚ù§Ô∏è HR Data (Page ${dataPage}): ${heartRate} BPM`);
                }
            }
        }

        function parsePowerMeterData(payload, channel) {
            const dataPage = payload[0];
            
            if (dataPage === 0x10) {
                // Standard Power-Only Main Data Page
                const eventCount = payload[1];
                const power = payload[5] | (payload[6] << 8);
                const cadence = payload[3];
                
                updateTrainerMetrics({
                    power: power,
                    cadence: cadence,
                    speed: (power / 10).toFixed(1),
                    resistance: Math.round(power / 20),
                    channel: channel,
                    deviceId: `PWR-${eventCount % 1000}`
                });
                
                log(`‚ö° Power Data: ${power}W, ${cadence}RPM`);
            }
        }

        function parseSpeedCadenceData(payload, channel) {
            // Speed/Cadence sensor data
            const cadenceEventTime = payload[0] | (payload[1] << 8);
            const cadenceRevCount = payload[2] | (payload[3] << 8);
            const speedEventTime = payload[4] | (payload[5] << 8);
            const speedRevCount = payload[6] | (payload[7] << 8);
            
            // Calculate cadence and speed (simplified)
            const cadence = cadenceRevCount % 255; // Simplified
            const speed = (speedRevCount / 10).toFixed(1); // Simplified
            
            updateTrainerMetrics({
                power: 0,
                cadence: cadence,
                speed: speed,
                resistance: 0,
                channel: channel,
                deviceId: `SPD-${channel}`
            });
            
            log(`üö¥ Speed/Cadence: ${speed}km/h, ${cadence}RPM`);
        }

        function parseGenericData(payload, channel, dataPage) {
            // Try to extract any meaningful data from unknown devices
            const payloadHex = payload.map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
            
            // Look for patterns that might indicate heart rate (common in watches)
            for (let i = 0; i < payload.length; i++) {
                const value = payload[i];
                if (value >= 40 && value <= 220) {
                    // Possible heart rate value
                    log(`üíì Possible HR detected: ${value} BPM at position ${i}`);
                    
                    // Try to update as heart rate
                    updateHRMMetrics({
                        heartRate: value,
                        channel: channel,
                        deviceId: `UNK-${channel}`,
                        dataPage: dataPage
                    });
                    break;
                }
            }
            
            // Log raw data for manual analysis
            log(`üìä Raw data analysis - Channel: ${channel}, Page: 0x${dataPage.toString(16)}`);
            log(`üìä Bytes: ${payloadHex}`);
            log(`üìä Decimal: ${payload.join(', ')}`);
        }

        function parseShifterData(payload, channel) {
            if (payload[0] === 0x22) { // Shifting data page
                const eventCount = payload[1];
                const gear = payload[2];
                const frontGear = payload[3];
                const rearGear = payload[4];
                
                updateShifterMetrics({
                    gear: gear,
                    frontGear: frontGear,
                    rearGear: rearGear,
                    channel: channel,
                    deviceId: `${channel}-${eventCount % 1000}`
                });
                
                log(`‚öôÔ∏è Shift Data: Gear ${gear} (${frontGear}T/${rearGear}T)`);
            }
        }

        function updateTrainerMetrics(data) {
            document.getElementById('power-value').textContent = data.power;
            document.getElementById('cadence-value').textContent = data.cadence;
            document.getElementById('speed-value').textContent = data.speed;
            document.getElementById('resistance-value').textContent = data.resistance;
            document.getElementById('trainer-device-id').textContent = data.deviceId;
            document.getElementById('trainer-channel').textContent = data.channel;
            
            // Calculate distance and time
            if (!sessionData.trainer.startTime) {
                sessionData.trainer.startTime = Date.now();
            }
            
            const elapsedTime = Date.now() - sessionData.trainer.startTime;
            const speedKmh = parseFloat(data.speed);
            sessionData.trainer.distance += speedKmh * (250 / 3600000); // 250ms interval
            
            document.getElementById('distance-value').textContent = sessionData.trainer.distance.toFixed(2);
            document.getElementById('time-value').textContent = formatTime(elapsedTime);
            
            // Track max power
            if (data.power > sessionData.trainer.maxPower) {
                sessionData.trainer.maxPower = data.power;
            }
            
            animateMetricUpdate('power-metric');
            animateMetricUpdate('cadence-metric');
            animateMetricUpdate('speed-metric');
        }

        function updateHRMMetrics(data) {
            document.getElementById('hr-value').textContent = data.heartRate;
            document.getElementById('hrm-device-id').textContent = data.deviceId;
            document.getElementById('hrm-channel').textContent = data.channel;
            
            // Calculate running average
            sessionData.hrm.hrHistory.push(data.heartRate);
            if (sessionData.hrm.hrHistory.length > 20) {
                sessionData.hrm.hrHistory.shift();
            }
            
            const avgHR = sessionData.hrm.hrHistory.reduce((a, b) => a + b, 0) / sessionData.hrm.hrHistory.length;
            document.getElementById('hr-avg').textContent = Math.round(avgHR);
            
            // Track max HR
            if (data.heartRate > sessionData.hrm.maxHR) {
                sessionData.hrm.maxHR = data.heartRate;
            }
            document.getElementById('hr-max').textContent = sessionData.hrm.maxHR;
            
            // Update HR zone
            updateHRZone(data.heartRate);
            
            animateMetricUpdate('hr-metric');
        }

        function updateShifterMetrics(data) {
            document.getElementById('gear-display').textContent = data.gear;
            document.getElementById('front-gear').textContent = data.frontGear;
            document.getElementById('rear-gear').textContent = data.rearGear;
            document.getElementById('shifter-device-id').textContent = data.deviceId;
            document.getElementById('shifter-channel').textContent = data.channel;
            
            // Calculate gear ratio
            if (data.frontGear > 0 && data.rearGear > 0) {
                const ratio = (data.frontGear / data.rearGear).toFixed(2);
                document.getElementById('gear-ratio').textContent = ratio;
            }
            
            animateMetricUpdate('front-gear-metric');
            animateMetricUpdate('rear-gear-metric');
        }

        function updateHRZone(heartRate) {
            const maxHR = 185; // Default max HR
            const zoneElement = document.getElementById('hr-zone');
            
            const zones = [
                { max: 0.6, name: 'Zone 1 - Recovery', class: 'zone-1' },
                { max: 0.7, name: 'Zone 2 - Aerobic Base', class: 'zone-2' },
                { max: 0.8, name: 'Zone 3 - Aerobic', class: 'zone-3' },
                { max: 0.9, name: 'Zone 4 - Threshold', class: 'zone-4' },
                { max: 1.0, name: 'Zone 5 - VO2 Max', class: 'zone-5' }
            ];
            
            const hrPercent = heartRate / maxHR;
            let currentZone = zones[zones.length - 1];
            
            for (let zone of zones) {
                if (hrPercent <= zone.max) {
                    currentZone = zone;
                    break;
                }
            }
            
            zoneElement.textContent = currentZone.name;
            zoneElement.className = `hr-zone ${currentZone.class}`;
        }

        function animateMetricUpdate(metricId) {
            const metric = document.getElementById(metricId);
            metric.classList.add('updated');
            setTimeout(() => metric.classList.remove('updated'), 300);
        }

        function updateLastDataTime(deviceType) {
            lastDataTimes[deviceType] = Date.now();
            const updateElement = document.getElementById(`${deviceType}-last-update`);
            updateElement.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
            
            // Update signal strength (simulate based on recent data)
            updateSignalStrength(deviceType, 4); // Strong signal
        }

        function updateSignalStrength(deviceType, strength) {
            for (let i = 1; i <= 5; i++) {
                const bar = document.getElementById(`${deviceType}-signal-${i}`);
                if (i <= strength) {
                    bar.classList.add('active');
                } else {
                    bar.classList.remove('active');
                }
            }
        }

        function updateDeviceStatus(device, status) {
            const statusIndicator = document.getElementById(`${device}-status`);
            const statusText = document.getElementById(`${device}-status-text`);
            const card = document.getElementById(`${device}-card`);
            
            switch (status) {
                case 'receiving':
                    statusIndicator.className = 'status-indicator status-active';
                    statusText.textContent = 'Receiving Data';
                    card.classList.add('receiving');
                    card.classList.remove('no-signal');
                    break;
                case 'searching':
                    statusIndicator.className = 'status-indicator status-searching';
                    statusText.textContent = 'Searching...';
                    card.classList.remove('receiving', 'no-signal');
                    break;
                case 'no-signal':
                default:
                    statusIndicator.className = 'status-indicator status-inactive';
                    statusText.textContent = 'No Signal';
                    card.classList.add('no-signal');
                    card.classList.remove('receiving');
                    break;
            }
        }

        async function sendANTMessage(messageType, data) {
            if (!antStick) return;

            const length = data.length;
            const message = [ANT_SYNC_BYTE, length, messageType, ...data];
            
            // Calculate checksum
            let checksum = 0;
            for (let i = 0; i < message.length; i++) {
                checksum ^= message[i];
            }
            message.push(checksum);

            const writer = antStick.writable.getWriter();
            await writer.write(new Uint8Array(message));
            writer.releaseLock();

            // Log hex representation
            const hexMessage = message.map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
            log(`üì§ TX: ${hexMessage}`);
        }

        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('usb-status-dot');
            const statusText = document.getElementById('usb-status-text');
            const connectBtn = document.getElementById('connect-btn');
            const antInfo = document.getElementById('ant-stick-info');
            const scanningControls = document.getElementById('scanning-controls');
            const discoveredDevices = document.getElementById('discovered-devices');

            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'ANT+ USB Stick: Connected';
                connectBtn.textContent = 'Disconnect';
                connectBtn.onclick = disconnectANTStick;
                antInfo.style.display = 'block';
                scanningControls.style.display = 'flex';
                discoveredDevices.style.display = 'block';
            } else {
                statusDot.classList.remove('connected', 'scanning');
                statusText.textContent = 'ANT+ USB Stick: Disconnected';
                connectBtn.textContent = 'Connect ANT+ USB';
                connectBtn.onclick = connectANTStick;
                antInfo.style.display = 'none';
                scanningControls.style.display = 'none';
                discoveredDevices.style.display = 'none';
            }
        }

        async function disconnectANTStick() {
            if (antStick) {
                try {
                    if (isScanning) {
                        await stopScanning();
                    }
                    
                    if (reader) {
                        await reader.cancel();
                        reader = null;
                    }
                    
                    await antStick.close();
                    antStick = null;
                    isConnected = false;
                    updateConnectionStatus(false);
                    log('üîå ANT+ USB receiver disconnected');
                } catch (error) {
                    log(`‚ùå Disconnect error: ${error.message}`);
                }
            }
        }

        function clearDevices() {
            receivedDevices = {};
            lastDataTimes = {};
            sessionData = {
                trainer: { distance: 0, startTime: null, maxPower: 0 },
                hrm: { avgHR: 0, maxHR: 0, hrHistory: [] }
            };
            
            // Reset all device displays
            ['trainer', 'shifter', 'hrm'].forEach(device => {
                updateDeviceStatus(device, 'no-signal');
                document.getElementById(`${device}-last-update`).textContent = 'Waiting for data...';
                updateSignalStrength(device, 0);
            });
            
            // Clear metrics
            document.querySelectorAll('.metric-value').forEach(element => {
                element.textContent = '---';
            });
            
            log('üßπ All devices and data cleared');
        }

        // Utility functions
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function log(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logContent.textContent += `[${timestamp}] ${message}\n`;
            logContent.scrollTop = logContent.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-content').textContent = '';
        }

        // Initialize
        updateConnectionStatus(false);
        ['trainer', 'shifter', 'hrm'].forEach(device => {
            updateDeviceStatus(device, 'no-signal');
        });

        log('üöÄ ANT+ Device Receiver initialized');
        log('üì± Connect ANT+ USB stick to begin receiving signals');
        
        // Check for Web Serial API support
        if (!('serial' in navigator)) {
            log('‚ö†Ô∏è Web Serial API not supported. Please use Chrome or Edge browser.');
        }

        // Monitor for signal timeouts
        setInterval(() => {
            const now = Date.now();
            ['trainer', 'shifter', 'hrm'].forEach(device => {
                if (lastDataTimes[device] && now - lastDataTimes[device] > 5000) {
                    updateDeviceStatus(device, 'no-signal');
                    updateSignalStrength(device, 0);
                }
            });
        }, 1000);
    </script>
</body>
</html>