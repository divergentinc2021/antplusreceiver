<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Cross-Platform ANT+ Receiver</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        @media (min-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            .container {
                padding: 20px;
            }
            .header {
                margin-bottom: 30px;
            }
        }

        .platform-info {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
            backdrop-filter: blur(10px);
        }

        .platform-detected {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .permission-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .permission-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .permission-granted {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .permission-denied {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .permission-unknown {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }

        .connection-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .connection-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .connection-options {
                grid-template-columns: 1fr 1fr;
            }
        }

        .connection-method {
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .connection-method.available {
            border-color: #2ecc71;
            background: #e8f5e8;
        }

        .connection-method.unavailable {
            border-color: #e74c3c;
            background: #fdf2f2;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .connection-method.active {
            border-color: #3498db;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .method-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .method-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .method-description {
            font-size: 0.9rem;
            color: #666;
        }

        .android-instructions {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .android-instructions h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .android-instructions ul {
            margin-left: 20px;
        }

        .android-instructions li {
            margin-bottom: 5px;
        }

        .warning-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #856404;
        }

        .btn-permission {
            background: linear-gradient(45deg, #f39c12, #d68910);
        }

        .btn-scan {
            background: linear-gradient(45deg, #27ae60, #229954);
        }

        .device-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            opacity: 0.6;
        }

        .device-card.receiving {
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            border: 2px solid #2ecc71;
        }

        .device-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .device-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .device-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .device-status {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-active { background-color: #2ecc71; }
        .status-inactive { background-color: #e74c3c; }
        .status-searching { background-color: #f39c12; animation: pulse 1s infinite; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        @media (min-width: 768px) {
            .metrics {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 10px;
            }
        }

        .metric {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .metric.updated {
            background: #d4edda;
            transform: scale(1.05);
        }

        .metric-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
        }

        @media (min-width: 768px) {
            .metric-value {
                font-size: 1.6rem;
            }
        }

        .metric-label {
            font-size: 0.7rem;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
            margin: 5px 0;
        }

        .btn:hover {
            background: linear-gradient(45deg, #2980b9, #1f639a);
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-stop {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .log-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .log-content {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .debug-info {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Fixed ANT+ Receiver</h1>
            <p>Cross-Platform Device Detection & Connection</p>
        </div>

        <div class="platform-info">
            <div class="platform-detected" id="platform-detected">üîç Detecting platform...</div>
            <div id="platform-capabilities">Checking connection capabilities...</div>
        </div>

        <!-- Android-specific instructions -->
        <div id="android-instructions" class="android-instructions" style="display: none;">
            <h4>üì± Android Setup Instructions</h4>
            <p><strong>Important:</strong> This page must be served over HTTPS for Bluetooth to work on Android.</p>
            <ul>
                <li>Open Chrome browser (other browsers may not support Web Bluetooth)</li>
                <li>Enable "Experimental Web Platform features" in chrome://flags</li>
                <li>Grant location permission when prompted (required for Bluetooth scanning)</li>
                <li>Make sure Bluetooth is enabled in Android settings</li>
                <li>Keep your ANT+ devices in pairing mode</li>
            </ul>
        </div>

        <!-- Permission Status Panel -->
        <div class="permission-panel">
            <h3>üîê Permissions & Requirements</h3>
            
            <div class="permission-item" id="https-status">
                <div>
                    <strong>üîí HTTPS Connection</strong>
                    <div style="font-size: 0.8rem; color: #666;">Required for Web Bluetooth on mobile</div>
                </div>
                <span id="https-indicator">‚ùì</span>
            </div>

            <div class="permission-item" id="bluetooth-api-status">
                <div>
                    <strong>üì∂ Web Bluetooth API</strong>
                    <div style="font-size: 0.8rem; color: #666;">Browser support for Bluetooth devices</div>
                </div>
                <span id="bluetooth-api-indicator">‚ùì</span>
            </div>

            <div class="permission-item" id="location-status" style="display: none;">
                <div>
                    <strong>üìç Location Permission</strong>
                    <div style="font-size: 0.8rem; color: #666;">Required for Bluetooth scanning on Android</div>
                </div>
                <div>
                    <span id="location-indicator">‚ùì</span>
                    <button class="btn btn-permission" id="request-location-btn" onclick="requestLocationPermission()" style="display: none; margin-left: 10px; width: auto; padding: 5px 10px;">Grant</button>
                </div>
            </div>

            <div class="permission-item" id="bluetooth-status">
                <div>
                    <strong>üîµ Bluetooth Device Access</strong>
                    <div style="font-size: 0.8rem; color: #666;">Permission to connect to Bluetooth devices</div>
                </div>
                <span id="bluetooth-indicator">‚ùì</span>
            </div>
        </div>

        <div class="connection-panel">
            <h3>üîó Connection Methods</h3>
            
            <!-- Warning for USB on Android -->
            <div id="usb-android-warning" class="warning-message" style="display: none;">
                <strong>‚ö†Ô∏è USB ANT+ Not Available on Android</strong><br>
                Android devices cannot access USB ANT+ sticks through web browsers. Use Bluetooth ANT+ devices instead.
            </div>

            <div class="connection-options">
                <!-- USB ANT+ Method -->
                <div class="connection-method" id="usb-method">
                    <div class="method-icon">üîå</div>
                    <div class="method-title">USB ANT+ Stick</div>
                    <div class="method-description">Direct USB connection (Windows/Mac/Linux only)</div>
                    <button class="btn" id="usb-connect-btn" onclick="connectUSB()" disabled>Connect USB</button>
                </div>

                <!-- Bluetooth ANT+ Method -->
                <div class="connection-method" id="bluetooth-method">
                    <div class="method-icon">üì±</div>
                    <div class="method-title">Bluetooth ANT+</div>
                    <div class="method-description">Bluetooth Low Energy (All platforms)</div>
                    <button class="btn" id="bluetooth-connect-btn" onclick="connectBluetooth()" disabled>Scan Bluetooth</button>
                </div>
            </div>

            <!-- Specific device scanning buttons -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px;">
                <button class="btn btn-scan" id="scan-kickr-btn" onclick="pairKickrCore()" disabled>Pair Kickr Core</button>
                <button class="btn btn-scan" id="scan-zwift-btn" onclick="pairZwiftClick()" disabled>Pair Zwift Click</button>
                <button class="btn btn-scan" id="scan-hrm-btn" onclick="pairHRM()" disabled>Pair Heart Rate</button>
            </div>

            <div id="connection-status" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;">
                <strong>Status:</strong> <span id="status-text">Disconnected</span>
            </div>
        </div>

        <!-- Wahoo Kickr Core Card -->
        <div class="device-card" id="kickr-card">
            <div class="device-header">
                <div class="device-icon" style="background: linear-gradient(45deg, #ff6b6b, #ff8e8e);">üö¥</div>
                <div>
                    <div class="device-title">Wahoo KICKR Core</div>
                    <div class="device-status">
                        <span class="status-indicator" id="kickr-status"></span>
                        <span id="kickr-status-text">No Signal</span>
                    </div>
                    <div style="font-size: 0.7rem; color: #999;" id="kickr-device-info">
                        Device: Not Connected
                    </div>
                </div>
            </div>

            <div class="metrics">
                <div class="metric" id="kickr-power-metric">
                    <div class="metric-value" id="kickr-power-value">---</div>
                    <div class="metric-label">Power (W)</div>
                </div>
                <div class="metric" id="kickr-cadence-metric">
                    <div class="metric-value" id="kickr-cadence-value">---</div>
                    <div class="metric-label">Cadence (RPM)</div>
                </div>
                <div class="metric" id="kickr-speed-metric">
                    <div class="metric-value" id="kickr-speed-value">---</div>
                    <div class="metric-label">Speed (KM/H)</div>
                </div>
                <div class="metric" id="kickr-resistance-metric">
                    <div class="metric-value" id="kickr-resistance-value">---</div>
                    <div class="metric-label">Resistance (%)</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn" onclick="pairKickrCore()">Pair KICKR Core</button>
                <button class="btn btn-stop" onclick="disconnectKickr()">Disconnect</button>
            </div>

            <div id="kickr-last-update" style="text-align: center; font-size: 0.8rem; color: #666; margin-top: 10px;">
                Waiting for connection...
            </div>
        </div>

        <!-- Zwift Click Card -->
        <div class="device-card" id="zwift-card">
            <div class="device-header">
                <div class="device-icon" style="background: linear-gradient(45deg, #28a745, #20c997);">‚ö°</div>
                <div>
                    <div class="device-title">Zwift Click</div>
                    <div class="device-status">
                        <span class="status-indicator" id="zwift-status"></span>
                        <span id="zwift-status-text">No Signal</span>
                    </div>
                    <div style="font-size: 0.7rem; color: #999;" id="zwift-device-info">
                        Device: Not Connected
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: center; align-items: center; margin: 20px 0;">
                <div style="text-align: center;">
                    <div style="font-size: 3rem; font-weight: bold; color: #2c3e50;" id="zwift-gear">1</div>
                    <div style="font-size: 0.8rem; color: #666;">Current Gear</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px;">
                <div class="metric">
                    <div class="metric-value" id="zwift-button-presses">0</div>
                    <div class="metric-label">Button Events</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="zwift-battery">---</div>
                    <div class="metric-label">Battery %</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn" onclick="pairZwiftClick()">Pair Zwift Click</button>
                <button class="btn btn-stop" onclick="disconnectZwift()">Disconnect</button>
            </div>

            <div id="zwift-last-update" style="text-align: center; font-size: 0.8rem; color: #666; margin-top: 10px;">
                Waiting for connection...
            </div>
        </div>

        <!-- Heart Rate Monitor Card -->
        <div class="device-card" id="hrm-card">
            <div class="device-header">
                <div class="device-icon" style="background: linear-gradient(45deg, #a8e6cf, #7fcdcd);">‚ù§Ô∏è</div>
                <div>
                    <div class="device-title">Heart Rate Monitor</div>
                    <div class="device-status">
                        <span class="status-indicator" id="hrm-status"></span>
                        <span id="hrm-status-text">No Signal</span>
                    </div>
                    <div style="font-size: 0.7rem; color: #999;" id="hrm-device-info">
                        Device: Not Connected
                    </div>
                </div>
            </div>

            <div class="metrics">
                <div class="metric" id="hr-current-metric">
                    <div class="metric-value" id="hr-current-value">---</div>
                    <div class="metric-label">BPM</div>
                </div>
                <div class="metric" id="hr-avg-metric">
                    <div class="metric-value" id="hr-avg-value">---</div>
                    <div class="metric-label">Avg BPM</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn" onclick="pairHRM()">Pair HRM</button>
                <button class="btn btn-stop" onclick="disconnectHRM()">Disconnect</button>
            </div>

            <div id="hrm-last-update" style="text-align: center; font-size: 0.8rem; color: #666; margin-top: 10px;">
                Waiting for connection...
            </div>
        </div>

        <!-- Debug Information -->
        <div class="debug-info" id="debug-info">
            <h4>üîç Debug Information</h4>
            <div id="debug-content">Platform detection and device checking enabled...</div>
        </div>

        <!-- Log Section -->
        <div class="log-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>üìã Connection Log</h3>
                <button onclick="clearLog()" style="background: #95a5a6; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Clear</button>
            </div>
            <div class="log-content" id="log-content"></div>
        </div>
    </div>

    <script>
        // Global variables
        let connectedDevices = new Map();
        let zwiftGear = 1;
        let zwiftButtonPresses = 0;
        let platform = null;
        let permissionStatus = {
            https: false,
            webBluetooth: false,
            location: 'prompt',
            bluetooth: 'prompt'
        };

        // Known Bluetooth service UUIDs
        const SERVICES = {
            HEART_RATE: 'heart_rate',
            CYCLING_POWER: 'cycling_power',
            FITNESS_EQUIPMENT: 'fitness_equipment',
            CYCLING_SPEED_CADENCE: 'cycling_speed_and_cadence',
            DEVICE_INFORMATION: 'device_information',
            BATTERY_SERVICE: 'battery_service',
            WAHOO_TRAINER: '6e40fec1-b5a3-f393-e0a9-e50e24dcca9e',
            WAHOO_TRAINER_CHAR: '6e40fec2-b5a3-f393-e0a9-e50e24dcca9e',
            HID_SERVICE: '00001812-0000-1000-8000-00805f9b34fb',
            HID_REPORT: '00002a4d-0000-1000-8000-00805f9b34fb'
        };

        // Platform detection with Android-specific handling
        function detectPlatform() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isMobile = /android|iphone|ipad|ipod|blackberry|iemobile|opera mini/.test(userAgent);
            const isAndroid = /android/.test(userAgent);
            const isIOS = /iphone|ipad|ipod/.test(userAgent);
            const isWindows = /windows/.test(userAgent);
            const isMac = /macintosh|mac os x/.test(userAgent);
            const isLinux = /linux/.test(userAgent);

            let platformName = 'Unknown';
            if (isAndroid) platformName = 'Android';
            else if (isIOS) platformName = 'iOS';
            else if (isWindows) platformName = 'Windows';
            else if (isMac) platformName = 'macOS';
            else if (isLinux) platformName = 'Linux';

            platform = {
                name: platformName,
                isMobile: isMobile,
                isAndroid: isAndroid,
                isIOS: isIOS,
                hasWebSerial: 'serial' in navigator,
                hasWebBluetooth: 'bluetooth' in navigator,
                hasWebUSB: 'usb' in navigator
            };

            if (isAndroid) {
                const androidInstructions = document.getElementById('android-instructions');
                const usbWarning = document.getElementById('usb-android-warning');
                if (androidInstructions) androidInstructions.style.display = 'block';
                if (usbWarning) usbWarning.style.display = 'block';
            }

            updatePlatformDisplay();
            checkPermissions();
            updateConnectionMethods();
        }

        function updatePlatformDisplay() {
            const platformElement = document.getElementById('platform-detected');
            const capabilitiesElement = document.getElementById('platform-capabilities');
            
            if (platformElement) {
                platformElement.textContent = `üì± Platform: ${platform.name}`;
            }
            
            if (capabilitiesElement) {
                let capabilities = [];
                if (platform.hasWebSerial) capabilities.push('USB ANT+');
                if (platform.hasWebBluetooth) capabilities.push('Bluetooth');
                if (platform.hasWebUSB) capabilities.push('WebUSB');
                
                if (capabilities.length > 0) {
                    capabilitiesElement.textContent = `‚úÖ Available APIs: ${capabilities.join(', ')}`;
                    capabilitiesElement.style.color = '#27ae60';
                } else {
                    capabilitiesElement.textContent = '‚ùå Limited connectivity options available';
                    capabilitiesElement.style.color = '#e74c3c';
                }
            }
        }

        async function checkPermissions() {
            permissionStatus.https = location.protocol === 'https:' || location.hostname === 'localhost';
            updatePermissionDisplay('https-status', 'https-indicator', permissionStatus.https);

            permissionStatus.webBluetooth = 'bluetooth' in navigator;
            updatePermissionDisplay('bluetooth-api-status', 'bluetooth-api-indicator', permissionStatus.webBluetooth);

            if (platform && platform.isAndroid && 'permissions' in navigator) {
                const locationStatus = document.getElementById('location-status');
                if (locationStatus) locationStatus.style.display = 'flex';
                
                try {
                    const result = await navigator.permissions.query({name: 'geolocation'});
                    permissionStatus.location = result.state;
                    updatePermissionDisplay('location-status', 'location-indicator', result.state === 'granted');
                    
                    if (result.state === 'prompt') {
                        const requestBtn = document.getElementById('request-location-btn');
                        if (requestBtn) requestBtn.style.display = 'inline-block';
                    }
                } catch (error) {
                    log('‚ö†Ô∏è Could not check location permission status');
                    permissionStatus.location = 'unknown';
                    updatePermissionDisplay('location-status', 'location-indicator', null);
                }
            }

            updateConnectionMethods();
        }

        function updatePermissionDisplay(itemId, indicatorId, granted) {
            const item = document.getElementById(itemId);
            const indicator = document.getElementById(indicatorId);
            
            if (!item || !indicator) return;
            
            if (granted === true) {
                item.className = 'permission-item permission-granted';
                indicator.textContent = '‚úÖ';
            } else if (granted === false) {
                item.className = 'permission-item permission-denied';
                indicator.textContent = '‚ùå';
            } else {
                item.className = 'permission-item permission-unknown';
                indicator.textContent = '‚ùì';
            }
        }

        async function requestLocationPermission() {
            try {
                await navigator.geolocation.getCurrentPosition(() => {}, () => {});
                const result = await navigator.permissions.query({name: 'geolocation'});
                permissionStatus.location = result.state;
                updatePermissionDisplay('location-status', 'location-indicator', result.state === 'granted');
                const requestBtn = document.getElementById('request-location-btn');
                if (requestBtn) requestBtn.style.display = 'none';
                updateConnectionMethods();
                log('‚úÖ Location permission granted');
            } catch (error) {
                log(`‚ùå Location permission denied: ${error.message}`);
            }
        }

        function updateConnectionMethods() {
            const usbMethod = document.getElementById('usb-method');
            const bluetoothMethod = document.getElementById('bluetooth-method');
            const usbBtn = document.getElementById('usb-connect-btn');
            const bluetoothBtn = document.getElementById('bluetooth-connect-btn');
            const scanKickrBtn = document.getElementById('scan-kickr-btn');
            const scanZwiftBtn = document.getElementById('scan-zwift-btn');
            const scanHrmBtn = document.getElementById('scan-hrm-btn');
            
            if (!platform) return;
            
            if (platform.hasWebSerial && !platform.isMobile) {
                if (usbMethod) usbMethod.classList.add('available');
                if (usbBtn) usbBtn.disabled = false;
                log('‚úÖ USB ANT+ stick connection available');
            } else {
                if (usbMethod) usbMethod.classList.add('unavailable');
                if (usbBtn) usbBtn.disabled = true;
                if (platform.isAndroid) {
                    log('‚ÑπÔ∏è USB ANT+ not supported on Android');
                } else if (platform.isMobile) {
                    log('‚ÑπÔ∏è USB ANT+ not available on mobile devices');
                } else {
                    log('‚ùå Web Serial API not supported in this browser');
                }
            }
            
            const bluetoothAvailable = platform.hasWebBluetooth && 
                                       permissionStatus.https && 
                                       (!platform.isAndroid || permissionStatus.location === 'granted');
            
            if (bluetoothAvailable) {
                if (bluetoothMethod) bluetoothMethod.classList.add('available');
                if (bluetoothBtn) bluetoothBtn.disabled = false;
                if (scanKickrBtn) scanKickrBtn.disabled = false;
                if (scanZwiftBtn) scanZwiftBtn.disabled = false;
                if (scanHrmBtn) scanHrmBtn.disabled = false;
                log('‚úÖ Bluetooth ANT+ connection available');
            } else {
                if (bluetoothMethod) bluetoothMethod.classList.add('unavailable');
                if (bluetoothBtn) bluetoothBtn.disabled = true;
                if (scanKickrBtn) scanKickrBtn.disabled = true;
                if (scanZwiftBtn) scanZwiftBtn.disabled = true;
                if (scanHrmBtn) scanHrmBtn.disabled = true;
                
                if (!platform.hasWebBluetooth) {
                    log('‚ùå Web Bluetooth API not supported');
                } else if (!permissionStatus.https) {
                    log('‚ùå HTTPS required for Bluetooth on mobile');
                } else if (platform.isAndroid && permissionStatus.location !== 'granted') {
                    log('‚ùå Location permission required for Bluetooth on Android');
                }
            }

            updatePermissionDisplay('bluetooth-status', 'bluetooth-indicator', bluetoothAvailable);
        }

        async function connectUSB() {
            if (!platform || !platform.hasWebSerial) {
                alert('Web Serial API not supported on this platform');
                return;
            }

            try {
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 57600 });
                
                updateConnectionStatus('Connected via USB ANT+', 'success');
                log('üîå USB ANT+ stick connected successfully');
                
            } catch (error) {
                log(`‚ùå USB connection failed: ${error.message}`);
                updateConnectionStatus('USB connection failed', 'error');
            }
        }

        async function connectBluetooth() {
            if (!checkBluetoothRequirements()) return;

            try {
                log('üîç Scanning for Bluetooth ANT+ devices...');
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: ['heart_rate'] },
                        { services: ['cycling_power'] },
                        { services: ['cycling_speed_and_cadence'] },
                        { services: ['fitness_equipment'] },
                        { namePrefix: 'KICKR' },
                        { namePrefix: 'SNAP' },
                        { namePrefix: 'Wahoo' },
                        { namePrefix: 'Garmin' },
                        { namePrefix: 'Polar' }
                    ],
                    optionalServices: [
                        'device_information',
                        'battery_service',
                        'generic_access',
                        '6e40fec1-b5a3-f393-e0a9-e50e24dcca9e'
                    ]
                });

                log(`üì± Found device: ${device.name || 'Unknown Device'}`);
                
                const server = await device.gatt.connect();
                updateConnectionStatus(`Connected to ${device.name || 'Bluetooth Device'}`, 'success');
                
            } catch (error) {
                log(`‚ùå Bluetooth connection failed: ${error.message}`);
                if (error.message.includes('User cancelled')) {
                    updateConnectionStatus('Connection cancelled by user', 'warning');
                } else {
                    updateConnectionStatus('Bluetooth connection failed', 'error');
                }
            }
        }

        function updateConnectionStatus(message, type) {
            const statusDiv = document.getElementById('connection-status');
            const statusText = document.getElementById('status-text');
            
            if (!statusDiv || !statusText) return;
            
            statusDiv.style.display = 'block';
            statusText.textContent = message;
            
            if (type === 'success') {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
            } else {
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.style.border = '1px solid #ffeaa7';
            }
        }

        function checkBluetoothRequirements() {
            if (!platform || !platform.hasWebBluetooth) {
                alert('Web Bluetooth API not supported on this platform');
                return false;
            }

            if (platform.isAndroid && permissionStatus.location !== 'granted') {
                alert('Location permission is required for Bluetooth scanning on Android. Please grant location permission first.');
                return false;
            }

            if (!permissionStatus.https) {
                alert('HTTPS connection is required for Bluetooth on mobile devices');
                return false;
            }

            return true;
        }

        function log(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logContent.textContent += `[${timestamp}] ${message}\n`;
            logContent.scrollTop = logContent.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log-content').textContent = '';
        }

        function updateDebugInfo(info) {
            document.getElementById('debug-content').innerHTML = info;
        }

        function updateDeviceStatus(deviceType, status, deviceName = null) {
            const statusIndicator = document.getElementById(`${deviceType}-status`);
            const statusText = document.getElementById(`${deviceType}-status-text`);
            const card = document.getElementById(`${deviceType}-card`);
            const deviceInfo = document.getElementById(`${deviceType}-device-info`);
            
            if (!statusIndicator || !statusText) return;
            
            switch (status) {
                case 'receiving':
                    statusIndicator.className = 'status-indicator status-active';
                    statusText.textContent = 'Connected';
                    if (card) card.classList.add('receiving');
                    if (deviceInfo && deviceName) deviceInfo.textContent = `Device: ${deviceName}`;
                    break;
                case 'searching':
                    statusIndicator.className = 'status-indicator status-searching';
                    statusText.textContent = 'Searching...';
                    if (card) card.classList.remove('receiving');
                    if (deviceInfo) deviceInfo.textContent = 'Scanning for devices...';
                    break;
                default:
                    statusIndicator.className = 'status-indicator status-inactive';
                    statusText.textContent = 'Disconnected';
                    if (card) card.classList.remove('receiving');
                    if (deviceInfo) deviceInfo.textContent = 'Device: Not Connected';
                    break;
            }
        }

        function animateMetricUpdate(metricId) {
            const metric = document.getElementById(metricId);
            if (metric) {
                metric.classList.add('updated');
                setTimeout(() => metric.classList.remove('updated'), 300);
            }
        }

        // Enhanced KICKR Core pairing with proper service discovery
        async function pairKickrCore() {
            if (!checkBluetoothRequirements()) return;

            try {
                log('üîç Scanning for Wahoo KICKR Core...');
                updateDeviceStatus('kickr', 'searching');
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: 'KICKR CORE' },
                        { namePrefix: 'KICKR' },
                        { namePrefix: 'Wahoo' },
                        { services: [SERVICES.FITNESS_EQUIPMENT] },
                        { services: [SERVICES.CYCLING_POWER] },
                        { services: [SERVICES.WAHOO_TRAINER] }
                    ],
                    optionalServices: [
                        SERVICES.FITNESS_EQUIPMENT,
                        SERVICES.CYCLING_POWER,
                        SERVICES.CYCLING_SPEED_CADENCE,
                        SERVICES.DEVICE_INFORMATION,
                        SERVICES.BATTERY_SERVICE,
                        SERVICES.WAHOO_TRAINER
                    ]
                });

                log(`üì± Found device: ${device.name || 'Unknown KICKR'}`);
                
                const server = await device.gatt.connect();
                log('üîó Connected to GATT server');
                
                connectedDevices.set('kickr', {
                    device: device,
                    server: server,
                    type: 'kickr'
                });
                
                updateDeviceStatus('kickr', 'receiving', device.name);
                
                await discoverKickrServices(server);
                await monitorKickrData(server);
                
            } catch (error) {
                log(`‚ùå KICKR Core pairing failed: ${error.message}`);
                updateDeviceStatus('kickr', 'inactive');
                
                if (error.message.includes('User cancelled')) {
                    log('‚ÑπÔ∏è User cancelled device selection');
                } else if (error.message.includes('not found')) {
                    log('‚ÑπÔ∏è No KICKR devices found. Make sure your KICKR Core is in pairing mode');
                } else {
                    log(`üîß Debug: ${error.stack}`);
                }
            }
        }

        async function discoverKickrServices(server) {
            try {
                log('üîç Discovering available services...');
                let debugInfo = '<strong>Available Services:</strong><br>';
                
                try {
                    const services = await server.getPrimaryServices();
                    debugInfo += `Found ${services.length} services:<br>`;
                    
                    for (let service of services) {
                        const uuid = service.uuid;
                        debugInfo += `‚Ä¢ ${uuid}`;
                        
                        if (uuid === '0000180d-0000-1000-8000-00805f9b34fb') debugInfo += ' (Heart Rate)';
                        else if (uuid === '00001818-0000-1000-8000-00805f9b34fb') debugInfo += ' (Cycling Power)';
                        else if (uuid === '00001826-0000-1000-8000-00805f9b34fb') debugInfo += ' (Fitness Equipment)';
                        else if (uuid === '6e40fec1-b5a3-f393-e0a9-e50e24dcca9e') debugInfo += ' (Wahoo Custom)';
                        
                        debugInfo += '<br>';
                        
                        try {
                            const characteristics = await service.getCharacteristics();
                            for (let char of characteristics) {
                                debugInfo += `  ‚îî‚îÄ Characteristic: ${char.uuid}<br>`;
                            }
                        } catch (e) {
                            debugInfo += `  ‚îî‚îÄ Could not read characteristics: ${e.message}<br>`;
                        }
                    }
                } catch (e) {
                    debugInfo += `Error discovering services: ${e.message}<br>`;
                }
                
                updateDebugInfo(debugInfo);
                
            } catch (error) {
                log(`‚ùå Service discovery failed: ${error.message}`);
            }
        }

        async function monitorKickrData(server) {
            try {
                log('üìä Starting KICKR data monitoring...');
                
                try {
                    const ftmsService = await server.getPrimaryService(SERVICES.FITNESS_EQUIPMENT);
                    const indoorBikeChar = await ftmsService.getCharacteristic('indoor_bike_data');
                    
                    await indoorBikeChar.startNotifications();
                    indoorBikeChar.addEventListener('characteristicvaluechanged', handleKickrFTMSData);
                    log('‚úÖ FTMS Indoor Bike Data monitoring started');
                } catch (e) {
                    log(`‚ÑπÔ∏è FTMS service not available: ${e.message}`);
                }
                
                try {
                    const powerService = await server.getPrimaryService(SERVICES.CYCLING_POWER);
                    const powerMeasurement = await powerService.getCharacteristic('cycling_power_measurement');
                    
                    await powerMeasurement.startNotifications();
                    powerMeasurement.addEventListener('characteristicvaluechanged', handleKickrPowerData);
                    log('‚úÖ Cycling Power monitoring started');
                } catch (e) {
                    log(`‚ÑπÔ∏è Cycling Power service not available: ${e.message}`);
                }
                
            } catch (error) {
                log(`‚ùå Failed to start KICKR monitoring: ${error.message}`);
            }
        }

        function handleKickrFTMSData(event) {
            try {
                const value = event.target.value;
                const flags = value.getUint16(0, true);
                let offset = 2;
                
                let data = { timestamp: Date.now() };
                
                if (flags & 0x01) {
                    data.speed = (value.getUint16(offset, true) * 0.01).toFixed(1);
                    offset += 2;
                }
                
                if (flags & 0x08) {
                    data.cadence = Math.round(value.getUint16(offset, true) * 0.5);
                    offset += 2;
                }
                
                if (flags & 0x40) {
                    data.power = value.getInt16(offset, true);
                    offset += 2;
                }
                
                updateKickrMetrics(data);
                log(`üö¥ FTMS Data - Power: ${data.power || 0}W, Cadence: ${data.cadence || 0}RPM, Speed: ${data.speed || 0}km/h`);
                
            } catch (error) {
                log(`‚ùå Error parsing FTMS data: ${error.message}`);
            }
        }

        function handleKickrPowerData(event) {
            try {
                const value = event.target.value;
                const flags = value.getUint16(0, true);
                const power = value.getUint16(2, true);
                
                let data = { power: power, timestamp: Date.now() };
                
                if (flags & 0x20 && value.byteLength >= 6) {
                    const crankRevs = value.getUint16(4, true);
                    const crankTime = value.getUint16(6, true);
                    data.cadence = Math.round(crankRevs * 1024 / crankTime);
                }
                
                updateKickrMetrics(data);
                log(`‚ö° Power Data - ${power}W${data.cadence ? `, ${data.cadence}RPM` : ''}`);
                
            } catch (error) {
                log(`‚ùå Error parsing power data: ${error.message}`);
            }
        }

        function updateKickrMetrics(data) {
            if (data.power !== undefined) {
                document.getElementById('kickr-power-value').textContent = data.power;
                animateMetricUpdate('kickr-power-metric');
            }
            
            if (data.cadence !== undefined) {
                document.getElementById('kickr-cadence-value').textContent = data.cadence;
                animateMetricUpdate('kickr-cadence-metric');
            }
            
            if (data.speed !== undefined) {
                document.getElementById('kickr-speed-value').textContent = data.speed;
                animateMetricUpdate('kickr-speed-metric');
            }
            
            if (data.resistance !== undefined) {
                document.getElementById('kickr-resistance-value').textContent = data.resistance;
                animateMetricUpdate('kickr-resistance-metric');
            }
            
            document.getElementById('kickr-last-update').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
        }

        // Enhanced Zwift Click and HRM pairing (placeholder implementations)
        async function pairZwiftClick() {
            if (!checkBluetoothRequirements()) return;
            log('üîç Zwift Click pairing not fully implemented yet');
            updateDeviceStatus('zwift', 'searching');
            // TODO: Implement Zwift Click pairing
        }

        async function pairHRM() {
            if (!checkBluetoothRequirements()) return;

            try {
                log('üîç Scanning for Heart Rate Monitor...');
                updateDeviceStatus('hrm', 'searching');
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: [SERVICES.HEART_RATE] }
                    ],
                    optionalServices: [SERVICES.DEVICE_INFORMATION, SERVICES.BATTERY_SERVICE]
                });

                log(`üì± Found HRM: ${device.name || 'Unknown HRM'}`);
                
                const server = await device.gatt.connect();
                connectedDevices.set('hrm', { device, server, type: 'hrm' });
                
                updateDeviceStatus('hrm', 'receiving', device.name);
                
                const hrService = await server.getPrimaryService(SERVICES.HEART_RATE);
                const hrCharacteristic = await hrService.getCharacteristic('heart_rate_measurement');
                
                await hrCharacteristic.startNotifications();
                hrCharacteristic.addEventListener('characteristicvaluechanged', handleHRMData);
                
                log('‚úÖ Heart Rate monitoring started');
                
            } catch (error) {
                log(`‚ùå HRM pairing failed: ${error.message}`);
                updateDeviceStatus('hrm', 'inactive');
            }
        }

        function handleHRMData(event) {
            try {
                const value = event.target.value;
                const heartRate = value.getUint8(1);
                
                document.getElementById('hr-current-value').textContent = heartRate;
                animateMetricUpdate('hr-current-metric');
                
                const currentAvg = parseInt(document.getElementById('hr-avg-value').textContent) || heartRate;
                const newAvg = Math.round((currentAvg + heartRate) / 2);
                document.getElementById('hr-avg-value').textContent = newAvg;
                
                document.getElementById('hrm-last-update').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
                
                log(`‚ù§Ô∏è Heart Rate: ${heartRate} BPM`);
                
            } catch (error) {
                log(`‚ùå Error parsing HRM data: ${error.message}`);
            }
        }

        // Disconnect functions
        function disconnectKickr() {
            const connection = connectedDevices.get('kickr');
            if (connection && connection.device.gatt.connected) {
                connection.device.gatt.disconnect();
                connectedDevices.delete('kickr');
                updateDeviceStatus('kickr', 'inactive');
                log('üö¥ KICKR Core disconnected');
            }
        }

        function disconnectZwift() {
            const connection = connectedDevices.get('zwift');
            if (connection && connection.device.gatt.connected) {
                connection.device.gatt.disconnect();
                connectedDevices.delete('zwift');
                updateDeviceStatus('zwift', 'inactive');
                log('‚ö° Zwift Click disconnected');
            }
        }

        function disconnectHRM() {
            const connection = connectedDevices.get('hrm');
            if (connection && connection.device.gatt.connected) {
                connection.device.gatt.disconnect();
                connectedDevices.delete('hrm');
                updateDeviceStatus('hrm', 'inactive');
                log('‚ù§Ô∏è Heart Rate Monitor disconnected');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Fixed ANT+ receiver initialized');
            
            // Detect platform and check capabilities
            detectPlatform();
            
            if (!navigator.bluetooth) {
                log('‚ùå Web Bluetooth not supported in this browser');
                log('‚ÑπÔ∏è Try using Chrome, Edge, or another Chromium-based browser');
            } else {
                log('‚úÖ Web Bluetooth is supported');
            }
            
            updateDeviceStatus('kickr', 'inactive');
            updateDeviceStatus('zwift', 'inactive');
            updateDeviceStatus('hrm', 'inactive');
            
            if (platform && platform.isAndroid) {
                log('üì± Android detected - make sure you\'re using Chrome browser');
                log('üîê HTTPS and location permissions required for Bluetooth');
            }
            
            document.addEventListener('bluetoothdevicedisconnected', (event) => {
                const deviceName = event.target.name || 'Unknown device';
                log(`‚ö†Ô∏è Device disconnected: ${deviceName}`);
                
                for (let [key, connection] of connectedDevices) {
                    if (connection.device === event.target) {
                        connectedDevices.delete(key);
                        updateDeviceStatus(key, 'inactive');
                        break;
                    }
                }
            });

            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    log('üì± App moved to background');
                } else {
                    log('üì± App brought to foreground');
                    for (let [key, connection] of connectedDevices) {
                        if (connection.device && !connection.device.gatt.connected) {
                            log(`üîÑ Attempting to reconnect ${key}...`);
                            connection.device.gatt.connect().then(() => {
                                log(`‚úÖ Reconnected ${key} successfully`);
                                updateConnectionStatus(`Reconnected to ${connection.device.name}`, 'success');
                            }).catch(error => {
                                log(`‚ùå ${key} reconnection failed: ${error.message}`);
                            });
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
